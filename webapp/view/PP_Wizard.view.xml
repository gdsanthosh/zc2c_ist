<mvc:View xmlns:mvc="sap.ui.core.mvc" controllerName="com.zc2c.ist.zc2cist.controller.PP_Wizard"
    xmlns="sap.m"
    xmlns:f="sap.ui.layout.form" displayBlock="true"
    xmlns:core="sap.ui.core">

    <Page id="wizPage" title="Create Packaging Proposal" class="sapUiContentPadding" showNavButton="true" navButtonPress=".onNavBack">
        <content>
            <Wizard id="wiz" stepActivate=".onStepActivate"  finishButtonText="" >

                <!-- STEP 1: Plant -->
                <WizardStep id="step1" title="Select Plant">
                    <f:SimpleForm id="frmPlant" editable="true" layout="ResponsiveGridLayout" labelSpanXL="3" labelSpanL="3" labelSpanM="4" labelSpanS="12" adjustLabelSpan="false" singleContainerFullSize="false">

                        <f:content>
                            <!-- Header -->
                            <Toolbar>
                                <Title text="Plant Assignment" level="H3"/>
                                <ToolbarSpacer/>
                                <Button text="{i18n>viewOpenProposals}" icon="sap-icon://list" type="Transparent" press=".onGoToOpenProposals"/>
                            </Toolbar>

                            <!-- Assigned Plant (read-only) -->
                            <Label text="Assigned Plant"/>
                            <HBox>
                                <Text text="{= ${local>/Plant} ? ${local>/Plant} + ' - ' + (${local>/PlantName} || '') : '' }" class="sapUiSmallMarginEnd"/>
                            </HBox>

                            <!-- Select Plant dropdown -->
                            <Label text="Select Plant" visible="{= !${local>/Plant} }"/>
                            <HBox visible="{= !${local>/Plant} }">
                                <ComboBox id="selPlant" width="15rem" selectedKey="{local>/SelectedPlant}" items="{plants>/}">
                                    <core:ListItem xmlns:core="sap.ui.core" key="{plants>Plant}" text="{plants>Plant} - {plants>Plantname}"/>
                                </ComboBox>
                                <Button id="btnAssignPlant" text="Assign Plant" type="Emphasized" enabled="{= !!${local>/SelectedPlant} }" press=".onAssignPlant" class="sapUiTinyMarginBegin"/>
                            </HBox>
                        </f:content>
                    </f:SimpleForm>
                </WizardStep>

                <!-- STEP 2: Containers -->
                <WizardStep id="step2" title="Select Containers" validated="false">
                    <VBox class="sapUiSmallMarginTop sapUiSmallMarginBottom" width="100%">
                        <Toolbar>
                            <Title text="Containers for plant {local>/Plant}" level="H3" />
                            <ToolbarSpacer/>
                            <Label text="Account" labelFor="cbAccountFilter" class="sapUiSmallMarginEnd"/>
                            <ComboBox id="cbAccountFilter" width="16rem" items="{local>/AccountNames}" selectedKey="{local>/SelectedAccount}" selectionChange=".onAccountFilterChange" placeholder="All Accounts">
                                <core:Item key="{local>Key}" text="{local>Name}"/>
                            </ComboBox>
                            <Button text="Get Samples" press=".onGetSamples" enabled="{local>/CanGetSamples}"/>
                            <Button id="btnAbandonStep2" text="Abandon Container" press=".onAbandonSelectedContainersStep2" enabled="{= ${local>/SelectedContainerCount} > 0 }" class="sapUiTinyMarginBegin"/>
                            <Button text="Create Packaging Proposal" type="Emphasized" press=".onCreateProposal" enabled="{local>/CanCreateProposal}"/>
                        </Toolbar>

                        <Table id="tblContainers" mode="MultiSelect" items="{path: 'local>/Containers'}" selectionChange=".onSelectRow" rememberSelections="false">
                            <columns>
                                <Column>
                                    <Text text="Container Id"/>
                                </Column>
                                <Column>
                                    <Text text="Instance(unique id)"/>
                                </Column>
                                <Column>
                                    <Text text="Account"/>
                                </Column>
                                <Column>
                                    <Text text="Samples Received"/>
                                </Column>
                                <Column>
                                    <Text text="Total Samples"/>
                                </Column>
                                <Column>
                                    <Text text="Pulled Samples"/>
                                </Column>
                                <Column visible="false">
                                    <Text text="Status"/>
                                </Column>
                                <Column>
                                    <Text text="Status"/>
                                </Column>
                            </columns>
                            <items>
                                <ColumnListItem selected="{= ${local>__selected} }">
                                    <cells>
                                        <Text text="{local>ContainerId}"/>
                                        <Text text="{local>ConInsId}"/>
                                        <Text text="{local>AccountName}"/>
                                        <Text text="{local>Samplesreceived}"/>
                                        <Text text="{local>ContainerTotal}"/>
                                        <Text text="{local>PulledSamples}"/>
                                        <Text text="{local>Status}"/>
                                        <Text text="{local>StatusDesc}"/>
                                    </cells>
                                </ColumnListItem>
                            </items>
                        </Table>
                    </VBox>
                </WizardStep>

                <!-- STEP 3: Review & Process -->
                <WizardStep id="step3" title="Process Proposal" validated="false" >
                    <VBox class="sapUiSmallMarginTop sapUiSmallMarginBottom" width="100%">
                        <Toolbar>
                            <Title text="Created Package ID: {local>/PackageId}" level="H3"/>
                            <ToolbarSpacer/>
                            <!-- NEW: Get Samples button for Proposal Items -->
                            <Button id="btnGetSamplesStep3" text="Get Samples" press=".onGetSamplesFromProposal" enabled="{local>/CanGetSamplesStep3}" />
                            <Button id="btnUnassignStep3" text="Unassign Container" press=".onUnassignContainer" enabled="{= ${local>/SelectedProposalCount} > 0 }" class="sapUiTinyMarginBegin"/>
                        </Toolbar>
                        <Table id="tblProposalItems" items="{local>/ProposalItems}" mode="MultiSelect" rememberSelections="false" selectionChange=".onSelectProposalItem">
                            <columns>
                                <Column>
                                    <Text text="Container Id"/>
                                </Column>
                                <Column>
                                    <Text text="Instance(ConInsId)"/>
                                </Column>
                            </columns>
                            <items>
                                <ColumnListItem>
                                    <cells>
                                        <Text text="{local>ContainerId}"/>
                                        <Text text="{local>ConInsId}"/>
                                    </cells>
                                </ColumnListItem>
                            </items>
                        </Table>

                        <Toolbar class="sapUiTinyMarginTop">
                            <Title text="Enter Processing Details" level="H4"/>
                        </Toolbar>
                        <f:SimpleForm editable="true" layout="ResponsiveGridLayout">
                            <Label text="Weight Gross"/>
                            <Input value="{local>/Process/WeightGross}" type="Number"/>
                            <Label text="Weight Dry Ice"/>
                            <Input value="{local>/Process/WeightDryIce}" type="Number"/>
                            <Label text="Weight Units"/>
                            <Input value="{local>/Process/WeightUnits}" editable="false"/>
                            <Label text="Package Material"/>
                            <!--<Input value="{local>/Process/PackageMaterial}"/>-->
                            <Input value="{local>/Process/PackageMaterial}" showValueHelp="true" valueHelpRequest=".onVH_PackageMaterial" placeholder="Chooseâ€¦"/>
                            <Label text="Comments"/>
                            <TextArea value="{local>/Process/Comments}" rows="3"/>
                        </f:SimpleForm>

                        <Toolbar class="sapUiTinyMarginTop">
                            <ToolbarSpacer/>
                            <Button text="Process Packaging Proposal" type="Emphasized" press=".onProcessProposal" enabled="{= !!${local>/PackageId} }"/>
                        </Toolbar>
                    </VBox>
                </WizardStep>

            </Wizard>
        </content>
    </Page>
</mvc:View>