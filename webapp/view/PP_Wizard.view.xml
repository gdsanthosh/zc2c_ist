<mvc:View xmlns:mvc="sap.ui.core.mvc" controllerName="com.zc2c.ist.zc2cist.controller.PP_Wizard"
    xmlns="sap.m"
    xmlns:f="sap.ui.layout.form" displayBlock="true"
    xmlns:core="sap.ui.core">

    <Page id="wizPage" title="{i18n>ppWizard.pageTitle}" class="sapUiContentPadding" showNavButton="true" navButtonPress=".onNavBack">
        <content>
            <Wizard id="wiz" stepActivate=".onStepActivate"  finishButtonText="" >

                <!-- STEP 1: Plant -->
                <WizardStep id="step1" title="{i18n>ppWizard.step1Title}">
                    <f:SimpleForm id="frmPlant" editable="true" layout="ResponsiveGridLayout" labelSpanXL="3" labelSpanL="3" labelSpanM="4" labelSpanS="12" adjustLabelSpan="false" singleContainerFullSize="false">

                        <f:content>
                            <!-- Header -->
                            <Toolbar>
                                <Title text="{i18n>ppWizard.plantAssignmentTitle}" level="H3"/>
                            </Toolbar>

                            <!-- Assigned Plant (read-only) -->
                            <Label text="{i18n>ppWizard.assignedPlant}"/>
                            <HBox>
                                <Text text="{= ${local>/Plant} ? ${local>/Plant} + ' - ' + (${local>/PlantName} || '') : '' }" class="sapUiSmallMarginEnd"/>
                            </HBox>

                            <!-- Select Plant dropdown -->
                            <Label text="{i18n>ppWizard.selectPlant}" visible="{= !${local>/Plant} }"/>
                            <HBox visible="{= !${local>/Plant} }">
                                <ComboBox id="selPlant" width="15rem" selectedKey="{local>/SelectedPlant}" items="{plants>/}">
                                    <core:ListItem xmlns:core="sap.ui.core" key="{plants>Plant}" text="{plants>Plant} - {plants>Plantname}"/>
                                </ComboBox>
                                <Button id="btnAssignPlant" text="{i18n>ppWizard.assignPlant}" type="Emphasized" enabled="{= !!${local>/SelectedPlant} }" press=".onAssignPlant" class="sapUiTinyMarginBegin"/>
                            </HBox>
                        </f:content>
                    </f:SimpleForm>
                </WizardStep>

                <!-- STEP 2: Containers -->
                <WizardStep id="step2" title="{i18n>ppWizard.step2Title}" validated="false">
                    <VBox class="sapUiSmallMarginTop sapUiSmallMarginBottom" width="100%">
                        <Toolbar>
                            
                            <ToolbarSpacer/>
                            <Button text="{i18n>ppWizard.viewShipmentHistory}" icon="sap-icon://list" type="Transparent" press=".onGoToOpenProposals"/>
                        </Toolbar>
                        <Toolbar>
                            <Title text="{= ${i18n>ppWizard.containersForPlant} + ' ' + ${local>/Plant} }" level="H3" />
                            <ToolbarSpacer/>
                            <Label text="{i18n>ppWizard.account}" labelFor="cbAccountFilter" class="sapUiSmallMarginEnd"/>
                            <ComboBox id="cbAccountFilter" width="16rem" items="{local>/AccountNames}" selectedKey="{local>/SelectedAccount}" selectionChange=".onAccountFilterChange" placeholder="{i18n>ppWizard.allAccounts}">
                                <core:Item key="{local>Key}" text="{local>Name}"/>
                            </ComboBox>
                            <Button text="{i18n>ppWizard.getSamples}" press=".onGetSamples" enabled="{local>/CanGetSamples}"/>
                            <Button id="btnAbandonStep2" text="{i18n>ppWizard.abandonContainer}" press=".onAbandonSelectedContainersStep2" enabled="{= ${local>/SelectedContainerCount} > 0 }" class="sapUiTinyMarginBegin"/>
                            <Button text="{i18n>ppWizard.packContainer}" type="Emphasized" press=".onCreateProposal" enabled="{local>/CanCreateProposal}"/>
                        </Toolbar>

                        <Table id="tblContainers" mode="MultiSelect" items="{path: 'local>/Containers'}" selectionChange=".onSelectRow" rememberSelections="false">
                            <columns>
                                <Column>
                                    <Text text="{i18n>ppWizard.containerId}"/>
                                </Column>
                                <Column>
                                    <Text text="{i18n>ppWizard.instanceUniqueId}"/>
                                </Column>
                                <Column>
                                    <Text text="{i18n>ppWizard.account}"/>
                                </Column>
                                <Column>
                                    <Text text="{i18n>ppWizard.samplesReceived}"/>
                                </Column>
                                <Column>
                                    <Text text="{i18n>ppWizard.totalSamples}"/>
                                </Column>
                                <Column>
                                    <Text text="{i18n>ppWizard.pulledSamples}"/>
                                </Column>
                                <Column visible="false">
                                    <Text text="{i18n>ppWizard.status}"/>
                                </Column>
                                <Column>
                                    <Text text="{i18n>ppWizard.status}"/>
                                </Column>
                            </columns>
                            <items>
                                <ColumnListItem selected="{= ${local>__selected} }">
                                    <cells>
                                        <Text text="{local>ContainerId}"/>
                                        <Text text="{local>ConInsId}"/>
                                        <Text text="{local>AccountName}"/>
                                        <Text text="{local>Samplesreceived}"/>
                                        <Text text="{local>ContainerTotal}"/>
                                        <Text text="{local>PulledSamples}"/>
                                        <Text text="{local>Status}"/>
                                        <Text text="{local>StatusDesc}"/>
                                    </cells>
                                </ColumnListItem>
                            </items>
                        </Table>
                    </VBox>
                </WizardStep>

                <!-- STEP 3: Review & Process -->
                <WizardStep id="step3" title="{i18n>ppWizard.step3Title}" validated="false" >
                    <VBox class="sapUiSmallMarginTop sapUiSmallMarginBottom" width="100%">
                        <Toolbar>
                            <Title text="{= ${i18n>ppWizard.createdPackageId} + ' ' + ${local>/PackageId} }" level="H3"/>
                            <ToolbarSpacer/>
                            <!-- NEW: Get Samples button for Proposal Items -->
                            <Button id="btnGetSamplesStep3" text="{i18n>ppWizard.getSamples}" press=".onGetSamplesFromProposal" enabled="{local>/CanGetSamplesStep3}" />
                            <Button id="btnUnassignStep3" text="{i18n>ppWizard.unassignContainer}" press=".onUnassignContainer" enabled="{= ${local>/SelectedProposalCount} > 0 }" class="sapUiTinyMarginBegin"/>
                        </Toolbar>
                        <Table id="tblProposalItems" items="{local>/ProposalItems}" mode="MultiSelect" rememberSelections="false" selectionChange=".onSelectProposalItem">
                            <columns>
                                <Column>
                                    <Text text="{i18n>ppWizard.containerId}"/>
                                </Column>
                                <Column>
                                    <Text text="{i18n>ppWizard.instanceConInsId}"/>
                                </Column>
                            </columns>
                            <items>
                                <ColumnListItem>
                                    <cells>
                                        <Text text="{local>ContainerId}"/>
                                        <Text text="{local>ConInsId}"/>
                                    </cells>
                                </ColumnListItem>
                            </items>
                        </Table>

                        <Toolbar class="sapUiTinyMarginTop">
                            <Title text="{i18n>ppWizard.processingDetailsTitle}" level="H4"/>
                        </Toolbar>
                        <f:SimpleForm editable="true" layout="ResponsiveGridLayout">
                            <Label text="{i18n>ppWizard.weightGross}"/>
                            <Input value="{local>/Process/WeightGross}" type="Number"/>
                            <Label text="{i18n>ppWizard.weightDryIce}"/>
                            <Input value="{local>/Process/WeightDryIce}" type="Number"/>
                            <Label text="{i18n>ppWizard.weightUnits}"/>
                            <Input value="{local>/Process/WeightUnits}" editable="false"/>
                            <Label text="{i18n>ppWizard.packageMaterial}"/>
                            <!--<Input value="{local>/Process/PackageMaterial}"/>-->
                            <Input value="{local>/Process/PackageMaterial}" showValueHelp="true" valueHelpRequest=".onVH_PackageMaterial" placeholder="{i18n>ppWizard.choosePlaceholder}"/>
                            <Label text="{i18n>ppWizard.comments}"/>
                            <TextArea value="{local>/Process/Comments}" rows="3"/>
                        </f:SimpleForm>

                        <Toolbar class="sapUiTinyMarginTop">
                            <ToolbarSpacer/>
                            <Button text="{i18n>ppWizard.processProposal}" type="Emphasized" press=".onProcessProposal" enabled="{= !!${local>/PackageId} }"/>
                        </Toolbar>
                    </VBox>
                </WizardStep>

            </Wizard>
        </content>
    </Page>
</mvc:View>
